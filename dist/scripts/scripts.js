"use strict";angular.module("escrutinioApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$locationProvider","$routeProvider",function(e,o){o.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",controllerAs:"login"}).when("/mesas",{templateUrl:"views/mesas.html",controller:"MesasCtrl",controllerAs:"mesasctrl"}).when("/carga",{templateUrl:"views/carga.html",controller:"CargaCtrl",controllerAs:"carga"}).when("/confirmacion",{templateUrl:"views/confirmacion.html",controller:"ConfirmacionCtrl",controllerAs:"confirmacion"}).otherwise({redirectTo:"/"}),e.hashPrefix("")}]),angular.module("escrutinioApp").controller("MainCtrl",["$location","$timeout","ConfigSrv",function(e,o,t){o(function(){e.url("/login")},3e3)}]),angular.module("escrutinioApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("escrutinioApp").controller("LoginCtrl",["$location","$scope","SessionSrv",function(e,o,t){o.errMsg="",o.submit=function(){o.errMsg="",t.login(o.user).then(function(){e.url("/mesas")},function(e){o.errMsg="Usuario y/o contraseña incorrectos",console.log(e)})}}]),angular.module("escrutinioApp").service("ConfigSrv",["$http","$location",function(e,o){var t={map:{baseUrl:"http://fti.hopto.org:8081/FiscalizacionNE/"}};return t.getBaseUrl=function(){return t.map.baseUrl},t}]),angular.module("escrutinioApp").service("SessionSrv",["$http","$q","ConfigSrv",function(e,o,t){var s,r,a={};return a.login=function(r){var a={username:r.name,password:r.password},n=o.defer();return e.post(t.getBaseUrl()+"api/login",a).then(function(e){s=e.data.access_token,n.resolve(s)},function(e){n.reject(e)}),n.promise},a.getToken=function(){return s},a.getUser=function(){return r},a}]),angular.module("escrutinioApp").controller("MesasCtrl",["$location","$scope","MesasSrv",function(e,o,t){t.getMesas().then(function(e){o.mesas=e}),o.setMesa=function(o,s){t.setMesa(s),e.url("/carga")}}]),angular.module("escrutinioApp").service("MesasSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){function r(e){var o={circuito:e[0].escuela,mesas:_.map(e,"mesa")};return console.log(o),o}var a,n,i={};return i.getMesas=function(){var n=o.defer(),i={"x-auth-token":s.getToken()};return e.get(t.getBaseUrl()+"fiscalApi/getMesas",{headers:i}).then(function(e){a=r(e.data),n.resolve(a)},function(e){n.reject(e)}),n.promise},i.setMesa=function(e){n=e},i.getMesa=function(){return n},i}]),angular.module("escrutinioApp").service("ResultadosSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){function r(e){var o,t=[],s={};return s.mesa=e,s.resultados=[],o=n.getDatosCloned(a,e,"mesa"),_.each(o.votos,function(e){s.resultados.push({partido:e.id,diputados:e.diputados,legisladores:e.legisladores})}),t.push(s),t}var a=[],n={};return n.getDatosCloned=function(e,o,t){var s=_.find(e,function(e){return e[t]==o});return _.cloneDeep(s)},n.getDatos=function(e,o,t){return _.find(e,function(e){return e[t]==o})},n.getDatosListaMesa=function(e,o){var t,s=n.getDatosCloned(a,e,"mesa"),r=!1;return s&&(console.log(s.votos),t=n.getDatosCloned(s.votos,o,"lista"),console.log(t),t&&(r=_.clone(t,!0))),r},n.setDatosListaMesa=function(e){var o,t=n.getDatos(a,e.mesa,"mesa");t?(o=n.getDatos(t.votos,e.lista,"lista"),o?(o.diputados=e.votos.diputados,o.legisladores=e.votos.legisladores):t.votos.push({lista:e.lista,id:e.id,diputados:e.votos.diputados,legisladores:e.votos.legisladores})):a.push({mesa:e.mesa,votos:[{lista:e.lista,id:e.id,diputados:e.votos.diputados,legisladores:e.votos.legisladores}]})},n.getDatosMesa=function(e){var o=_.cloneDeep(n.getDatosCloned(a,e,"mesa"));return o},n.cargarMesa=function(n){var i=o.defer();console.log(a);var l=r(n),u={"x-auth-token":s.getToken()};return e.post(t.getBaseUrl()+"fiscalApi/cargarMesas",l,{headers:u}).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},n}]),angular.module("escrutinioApp").controller("CargaCtrl",["$location","$scope","ListasSrv","MesasSrv","ResultadosSrv",function(e,o,t,s,r){function a(){var e=o.listas.shift(),t=r.getDatosListaMesa(s.getMesa(),e.lista);switch(o.partido=e,o.lista="Lista "+e.lista,e.lista){case 1:case 2:o.nombre=e.nombre;break;case 3:o.nombre="Total";break;case 187:o.nombre="AyL";break;case 505:o.nombre="FIT";break;default:o.nombre=""}t?(o.votos.diputados=t.diputados,o.votos.legisladores=t.legisladores):(o.votos.diputados="",o.votos.legisladores="")}o.partido=!1,o.listas=!1,o.mesa=s.getMesa(),o.votos={},o.lista="",o.nombre="",t.getListas().then(function(e){o.listas=e,a()}),o.agregarDatos=function(t){r.setDatosListaMesa({mesa:s.getMesa(),lista:o.partido.lista,id:o.partido.id,votos:{diputados:o.votos.diputados,legisladores:o.votos.legisladores}}),o.listas.length?a():e.url("/confirmacion")}}]),angular.module("escrutinioApp").service("ListasSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){var r,a={};return a.getListas=function(){var a=o.defer();if(r)a.resolve(_.clone(r,!0));else{var n={"x-auth-token":s.getToken()};e.get(t.getBaseUrl()+"fiscalApi/getPartidos",{headers:n}).then(function(e){r=e.data,a.resolve(_.clone(r,!0))},function(e){a.reject(e)})}return a.promise},a.getListaPorNumero=function(e){return _.find(r,function(o){return o.lista==e})},a}]),angular.module("escrutinioApp").controller("ConfirmacionCtrl",["$location","$scope","$timeout","ListasSrv","MesasSrv","ResultadosSrv",function(e,o,t,s,r,a){o.resultados=[],o.mensaje="",o.ok=!0;var n=a.getDatosMesa(r.getMesa());n.votos.length&&_.each(n.votos,function(e,t){switch(e.par=(t+1)%2==0,e.lista){case 187:e.nombre="AyL";break;case 505:e.nombre="FIT";break;case 507:e.nombre="1 País";break;default:e.nombre=s.getListaPorNumero(e.lista).nombre}o.resultados.push(e)}),o.corregir=function(){e.url("/carga")},o.cargarMesa=function(){a.cargarMesa(r.getMesa()).then(function(s){o.ok=!0,o.mensaje="Los datos se cargaron correctamente",t(function(){e.url("/mesas")},3e3)},function(e){o.ok=!1,o.mensaje="Hubo un error. Reintentar.",t(function(){o.mensaje=""},5e3)})}}]);