"use strict";angular.module("escrutinioApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$locationProvider","$routeProvider",function(e,o){o.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",controllerAs:"login"}).when("/mesas",{templateUrl:"views/mesas.html",controller:"MesasCtrl",controllerAs:"mesasctrl"}).when("/carga",{templateUrl:"views/carga.html",controller:"CargaCtrl",controllerAs:"carga"}).when("/confirmacion",{templateUrl:"views/confirmacion.html",controller:"ConfirmacionCtrl",controllerAs:"confirmacion"}).otherwise({redirectTo:"/"}),e.hashPrefix("")}]),angular.module("escrutinioApp").controller("MainCtrl",["$location","$timeout","ConfigSrv",function(e,o,t){o(function(){e.url("/login")},3e3)}]),angular.module("escrutinioApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("escrutinioApp").controller("LoginCtrl",["$location","$scope","SessionSrv",function(e,o,t){o.errMsg="",o.submit=function(){o.errMsg="",t.login(o.user).then(function(){e.url("/mesas")},function(e){o.errMsg="Usuario y/o contraseña incorrectos",console.log(e)})}}]),angular.module("escrutinioApp").service("ConfigSrv",["$http","$location",function(e,o){var t={map:{baseUrl:"http://fti.hopto.org:8081/FiscalizacionNE/"}};return t.getBaseUrl=function(){return t.map.baseUrl},t}]),angular.module("escrutinioApp").service("SessionSrv",["$http","$q","ConfigSrv",function(e,o,t){var s,a,r={};return r.login=function(a){var r={username:a.name,password:a.password},n=o.defer();return e.post(t.getBaseUrl()+"api/login",r).then(function(e){s=e.data.access_token,n.resolve(s)},function(e){n.reject(e)}),n.promise},r.getToken=function(){return s},r.getUser=function(){return a},r}]),angular.module("escrutinioApp").controller("MesasCtrl",["$location","$scope","MesasSrv",function(e,o,t){t.getMesas().then(function(e){o.mesas=e},function(o){e.url("/login")}),o.setMesa=function(o,s){t.setMesa(s),e.url("/carga")}}]),angular.module("escrutinioApp").service("MesasSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){function a(e){var o={circuito:e[0].escuela,mesas:_.map(e,"mesa")};return o}var r,n,i={};return i.getMesas=function(){var n=o.defer(),i={"x-auth-token":s.getToken()};return e.get(t.getBaseUrl()+"fiscalApi/getMesas",{headers:i}).then(function(e){r=a(e.data),n.resolve(r)},function(e){n.reject(e)}),n.promise},i.setMesa=function(e){n=e},i.getMesa=function(){return n},i}]),angular.module("escrutinioApp").service("ResultadosSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){function a(e){var o,t=[],s={};return s.mesa=e,s.resultados=[],o=n.getDatosCloned(r,e,"mesa"),_.each(o.votos,function(e){s.resultados.push({partido:e.id,diputados:e.diputados,legisladores:e.legisladores})}),t.push(s),t}var r=[],n={};return n.getDatosCloned=function(e,o,t){var s=_.find(e,function(e){return e[t]==o});return _.cloneDeep(s)},n.getDatos=function(e,o,t){return _.find(e,function(e){return e[t]==o})},n.getDatosListaMesa=function(e,o){var t,s=n.getDatosCloned(r,e,"mesa"),a=!1;return s&&(t=n.getDatosCloned(s.votos,o,"lista"),t&&(a=_.clone(t,!0))),a},n.setDatosListaMesa=function(e){var o,t=n.getDatos(r,e.mesa,"mesa");t?(o=n.getDatos(t.votos,e.lista,"lista"),o?(o.diputados=e.votos.diputados,o.legisladores=e.votos.legisladores):t.votos.push({lista:e.lista,id:e.id,diputados:e.votos.diputados,legisladores:e.votos.legisladores})):r.push({mesa:e.mesa,votos:[{lista:e.lista,id:e.id,diputados:e.votos.diputados,legisladores:e.votos.legisladores}]})},n.getDatosMesa=function(e){var o=_.cloneDeep(n.getDatosCloned(r,e,"mesa"));return o},n.cargarMesa=function(n){var i=o.defer();console.log(r);var l=a(n),u={"x-auth-token":s.getToken()};return e.post(t.getBaseUrl()+"fiscalApi/cargarMesas",l,{headers:u}).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},n}]),angular.module("escrutinioApp").controller("CargaCtrl",["$location","$scope","ListasSrv","MesasSrv","ResultadosSrv",function(e,o,t,s,a){function r(){var e=o.listas.shift(),t=a.getDatosListaMesa(s.getMesa(),e.lista);switch(o.partido=e,o.lista="Lista "+e.lista,e.lista){case 1:case 2:o.nombre=e.nombre;break;case 3:o.nombre="Total";break;default:o.nombre=""}t?(o.votos.diputados=t.diputados,o.votos.legisladores=t.legisladores):(o.votos.diputados="",o.votos.legisladores="")}o.partido=!1,o.listas=!1,o.mesa=s.getMesa(),o.votos={},o.lista="",o.nombre="",t.getListas().then(function(e){o.listas=e,r()},function(o){e.url("/login")}),o.agregarDatos=function(t){a.setDatosListaMesa({mesa:s.getMesa(),lista:o.partido.lista,id:o.partido.id,votos:{diputados:o.votos.diputados,legisladores:o.votos.legisladores}}),o.listas.length?r():e.url("/confirmacion")}}]),angular.module("escrutinioApp").service("ListasSrv",["$http","$q","ConfigSrv","SessionSrv",function(e,o,t,s){var a,r={};return r.getListas=function(){var r=o.defer();if(a)r.resolve(_.clone(a,!0));else{var n={"x-auth-token":s.getToken()};e.get(t.getBaseUrl()+"fiscalApi/getPartidos",{headers:n}).then(function(e){a=e.data,r.resolve(_.clone(a,!0))},function(e){r.reject(e)})}return r.promise},r.getListaPorNumero=function(e){return _.find(a,function(o){return o.lista==e})},r}]),angular.module("escrutinioApp").controller("ConfirmacionCtrl",["$location","$scope","$timeout","ListasSrv","MesasSrv","ResultadosSrv",function(e,o,t,s,a,r){o.resultados=[],o.mensaje="",o.ok=!0,o.totalDiputadosMatch=!0,o.totalLegisladoresMatch=!0,o.mensajeTotales="";var n={diputados:0,legisladores:0},i={diputados:0,legisladores:0},l=r.getDatosMesa(a.getMesa());l&&l.votos.length?_.each(l.votos,function(e,t){switch(e.par=(t+1)%2==0,e.lista){case 187:e.nombre="AyL";break;case 505:e.nombre="FIT";break;case 507:e.nombre="1 País";break;default:e.nombre=s.getListaPorNumero(e.lista).nombre}e.nombre.match(/total/gi)?(n.diputados=e.diputados?e.diputados:0,n.legisladores=e.legisladores?e.legisladores:0):(i.diputados+=e.diputados?e.diputados:0,i.legisladores+=e.legisladores?e.legisladores:0),o.resultados.push(e)}):e.url("/login"),i.diputados==n.diputados&&i.legisladores==n.legisladores||(o.mensajeTotales="Los votos totales no coinciden con el total cargado"),o.corregir=function(){e.url("/carga")},o.cargarMesa=function(){r.cargarMesa(a.getMesa()).then(function(s){o.ok=!0,o.mensaje="Los datos se cargaron correctamente",t(function(){e.url("/mesas")},3e3)},function(e){o.ok=!1,o.mensaje="Hubo un error. Reintentar.",t(function(){o.mensaje=""},5e3)})}}]);